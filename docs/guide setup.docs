# ğŸ¤– Complete AI Integration Setup Guide

## ğŸ“‹ Checklist: What's Missing vs What Exists

### âœ… ALREADY EXISTS (from your documents):
- [x] AIJob Model
- [x] ai_jobs Migration
- [x] AIController (complete)
- [x] AI Views (partial - modals and buttons)

### âŒ NEEDS TO BE CREATED:

1. **AIService.php** - Core AI logic (provided above)
2. **ProcessAIJob.php** - Queue job handler (provided above)
3. **AI Routes** - Web routes (provided above)
4. **OpenAI Configuration** - Config file setup (provided above)
5. **Enhanced AI Dashboard** - Complete dashboard (provided above)

---

## ğŸš€ Step-by-Step Implementation

### STEP 1: Create AIService Class

```bash
# Create the service file
mkdir -p app/Services
```

Then create `app/Services/AIService.php` with the code from artifact #1

### STEP 2: Create ProcessAIJob Queue Job

```bash
# Create the job
php artisan make:job ProcessAIJob
```

Then replace the content with the code from artifact #2

### STEP 3: Add Routes

Add to `routes/web.php` the routes from artifact #3

### STEP 4: Configure OpenAI

1. **Add to .env:**
```env
OPENAI_API_KEY=sk-proj-your-key-here
OPENAI_MODEL=gpt-4o
OPENAI_MAX_TOKENS=4000
OPENAI_TEMPERATURE=0.7
QUEUE_CONNECTION=database
```

2. **Add to config/services.php:**
```php
'openai' => [
    'api_key' => env('OPENAI_API_KEY'),
    'model' => env('OPENAI_MODEL', 'gpt-4o'),
    'max_tokens' => env('OPENAI_MAX_TOKENS', 4000),
    'temperature' => env('OPENAI_TEMPERATURE', 0.7),
],
```

### STEP 5: Setup Queue Tables

```bash
php artisan queue:table
php artisan migrate
```

### STEP 6: Create Views

1. **Replace/Update:** `resources/views/instructor/ai/index.blade.php` (you already have this)
2. **Create:** `resources/views/instructor/ai/dashboard.blade.php` (use artifact #5)
3. **Keep existing:** The modal and button partials you already have

### STEP 7: Update Existing Controllers

Add this method to your existing controllers:

**In QuestionBankController.php:**
```php
public function index(Request $request)
{
    // ... existing code ...
    
    // Add this at the end before returning view
    if ($request->has('ai_generate')) {
        session()->flash('show_ai_modal', true);
    }
    
    return view('instructor.question-bank.index', compact('questions', 'subjects'));
}
```

**In QuizController.php:**
```php
public function index(Request $request)
{
    // ... existing code ...
    
    if ($request->has('ai_analyze')) {
        session()->flash('show_analyze_modal', true);
    }
    
    return view('instructor.quizzes.index', compact('quizzes'));
}
```

---

## ğŸ§ª Testing Your AI Integration

### Test 1: Check OpenAI Connection

Create `routes/console.php` or run in tinker:

```php
use App\Services\AIService;

$aiService = new AIService();

// Test basic API call
$response = Http::withHeaders([
    'Authorization' => 'Bearer ' . config('services.openai.api_key'),
])->post('https://api.openai.com/v1/chat/completions', [
    'model' => 'gpt-4o',
    'messages' => [
        ['role' => 'user', 'content' => 'Say "AI is working!"']
    ],
    'max_tokens' => 50
]);

dd($response->json());
```

Expected output: Should return JSON with AI response "AI is working!"

### Test 2: Generate Questions

```php
php artisan tinker

use App\Models\AIJob;
use App\Models\Lesson;
use App\Jobs\ProcessAIJob;

// Create test lesson if needed
$lesson = Lesson::first();

$job = AIJob::create([
    'user_id' => 1, // Your instructor user ID
    'subject_id' => $lesson->subject_id,
    'job_type' => 'generate_questions',
    'parameters' => [
        'subject_id' => $lesson->subject_id,
        'lesson_ids' => [$lesson->id],
        'count' => 5,
        'difficulty' => 'medium',
        'types' => ['multiple_choice']
    ],
    'status' => 'pending'
]);

// Dispatch the job
ProcessAIJob::dispatch($job);

// Check job status after a few seconds
$job->fresh()->status; // Should be 'processing' or 'completed'
$job->fresh()->result; // Should contain generated questions
```

### Test 3: Validate Question

```php
use App\Models\QuestionBank;

$question = QuestionBank::first();

$job = AIJob::create([
    'user_id' => 1,
    'subject_id' => $question->subject_id,
    'job_type' => 'validate_question',
    'parameters' => ['question_id' => $question->id],
    'status' => 'pending'
]);

ProcessAIJob::dispatch($job);

// Check result
$job->fresh()->result; // Should contain validation scores
```

### Test 4: Analyze Quiz

```php
use App\Models\Quiz;

$quiz = Quiz::whereHas('attempts', function($q) {
    $q->where('status', 'completed');
})->first();

$job = AIJob::create([
    'user_id' => 1,
    'subject_id' => $quiz->subject_id,
    'job_type' => 'analyze_quiz',
    'parameters' => ['quiz_id' => $quiz->id],
    'status' => 'pending'
]);

ProcessAIJob::dispatch($job);

// Check result
$job->fresh()->result; // Should contain analysis
```

---

## âš™ï¸ Queue Worker Setup

### Development (Local Testing)

```bash
# Terminal 1: Run Laravel
php artisan serve

# Terminal 2: Run Queue Worker
php artisan queue:work --tries=3 --timeout=300
```

### Production (Supervisor)

Create `/etc/supervisor/conf.d/laravel-worker.conf`:

```ini
[program:laravel-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/your-project/artisan queue:work database --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=4
redirect_stderr=true
stdout_logfile=/var/www/your-project/storage/logs/worker.log
stopwaitsecs=3600
```

Then:
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start laravel-worker:*
```

---

## ğŸ› Troubleshooting Common Issues

### Issue 1: "API Key Not Found"
**Solution:**
```bash
php artisan config:clear
php artisan cache:clear
# Check .env file has OPENAI_API_KEY
```

### Issue 2: "Queue Not Processing"
**Solution:**
```bash
# Check if queue worker is running
ps aux | grep queue:work

# Start queue worker
php artisan queue:work
```

### Issue 3: "Timeout Errors"
**Solution:**
- Increase timeout in `ProcessAIJob.php`: `public $timeout = 600;`
- Increase max_execution_time in `php.ini`

### Issue 4: "Invalid JSON Response"
**Solution:**
- Check OpenAI model is correct (gpt-4o or gpt-3.5-turbo)
- Check API key is valid
- Try smaller requests (fewer questions)

### Issue 5: "Rate Limit Exceeded"
**Solution:**
- Wait 60 seconds
- Upgrade OpenAI plan
- Implement rate limiting in your app

---

## ğŸ’° Cost Estimation

### OpenAI Pricing (as of 2024):
- **GPT-4o:** $2.50 / 1M input tokens, $10.00 / 1M output tokens
- **GPT-3.5-Turbo:** $0.50 / 1M input tokens, $1.50 / 1M output tokens

### Estimated Costs Per Operation:

| Operation | Token Usage | GPT-4o Cost | GPT-3.5 Cost |
|-----------|-------------|-------------|--------------|
| Generate 10 questions | ~3000 tokens | $0.05-$0.15 | $0.01-$0.03 |
| Validate 1 question | ~500 tokens | $0.01-$0.03 | $0.002-$0.01 |
| Analyze 1 quiz | ~2000 tokens | $0.03-$0.08 | $0.01-$0.02 |

### Monthly Budget Example:
- 100 question generations: $5-$15
- 200 validations: $2-$6
- 50 quiz analyses: $1.50-$4

**Total: ~$10-$25/month** for moderate usage

---

## ğŸ“Š Monitoring & Maintenance

### Check Failed Jobs
```bash
php artisan queue:failed
```

### Retry Failed Jobs
```bash
php artisan queue:retry all
```

### Monitor Logs
```bash
tail -f storage/logs/laravel.log | grep "AI"
```

### Database Cleanup (Optional)
```bash
# Clean old completed jobs (older than 30 days)
php artisan tinker

AIJob::where('status', 'completed')
    ->where('completed_at', '<', now()->subDays(30))
    ->delete();
```

---

## ğŸ” Security Best Practices

1. **Never commit .env file**
2. **Rotate API keys regularly**
3. **Set spending limits in OpenAI dashboard**
4. **Implement rate limiting**
5. **Monitor API usage daily**
6. **Use different keys for dev/staging/production**
7. **Log all AI requests for audit**

---

## âœ… Final Checklist

Before going live, ensure:

- [ ] OpenAI API key configured
- [ ] Queue worker running
- [ ] Tested question generation
- [ ] Tested question validation
- [ ] Tested quiz analysis
- [ ] Error handling working
- [ ] Notifications working
- [ ] Logs being written
- [ ] Cost monitoring setup
- [ ] Rate limiting implemented
- [ ] Backup queue configured

---

## ğŸ‰ You're Done!

Your AI integration is complete. Users can now:

1. âœ… Generate questions from lessons automatically
2. âœ… Validate question quality with AI feedback
3. âœ… Analyze quiz performance with insights
4. âœ… View job history and statistics
5. âœ… Get AI-powered suggestions

**Next Steps:**
- Train instructors on AI features
- Monitor usage and costs
- Gather feedback
- Iterate and improve prompts
- Consider adding more AI features (essay grading, content recommendations, etc.)

---

## ğŸ“ Need Help?

If you encounter issues:
1. Check logs: `storage/logs/laravel.log`
2. Test OpenAI API directly: https://platform.openai.com/playground
3. Review queue status: `php artisan queue:failed`
4. Check documentation: https://laravel.com/docs/queues